<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—á—ë—Ç—á–∏–∫</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="./icon/128.png">
    
    <link rel="stylesheet" href="https://jen9-ops.github.io/library/style.css">
    <style>
        :root {
            --primary-color: #007bff; --success-color: #28a745; --danger-color: #dc3545;
            --info-color: #17a2b8; --secondary-color: #6c757d; --warning-color: #ffc107;
            --light-gray: #f8f9fa; --border-color: #dee2e6; --text-color: #333;
            --shadow-color: rgba(0, 0, 0, 0.08);
        }
        html, body { height: 100%; margin: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--light-gray); color: var(--text-color);
            display: flex; justify-content: center; align-items: center; padding: 15px;
        }
        .calculator {
            width: 100%; max-width: 550px; height: 90vh; background: #fff;
            padding: 25px; border-radius: 16px; box-shadow: 0 8px 30px var(--shadow-color);
            display: flex; flex-direction: column; position: relative;
        }
        
        .app-header {
            display: flex; justify-content: space-between; align-items: center;
            position: absolute; top: 15px; left: 15px; right: 15px;
        }
        .header-actions-right { display: flex; gap: 8px; }
        .app-header button {
            background: none; padding: 5px; border-radius: 50%;
            width: 36px; height: 36px; border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem;
        }
        .app-header button:hover { background-color: #f0f0f0; }
        
        .total-display { font-size: 2.5rem; font-weight: bold; text-align: center; margin-top: 30px; margin-bottom: 15px; color: var(--primary-color); word-break: break-all; flex-shrink: 0; }
        .controls { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; flex-shrink: 0; }
        #numberInput, #commentInput { font-family: inherit; font-size: 1rem; padding: 10px 14px; border: 1px solid var(--border-color); border-radius: 8px; transition: border-color 0.2s, box-shadow 0.2s; }
        #commentInput { resize: none; overflow: hidden; line-height: 1.5; }
        #numberInput:focus, #commentInput:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2); }
        
        button, .button-label { padding: 8px 14px; font-size: 0.9rem; border: none; font-weight: 500; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s; }
        button:hover, .button-label:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        button:active, .button-label:active { transform: scale(0.97); }

        .main-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        #addButton { background-color: var(--primary-color); color: white; }
        #subtractButton { background-color: var(--warning-color); color: #212529; }
        
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background-color: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 5px 25px rgba(0,0,0,0.2); width: 90%; max-width: 450px; position: relative; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 1.2rem; font-weight: 600; }
        .close-button { background: none; border: none; font-size: 2rem; line-height: 1; cursor: pointer; color: #aaa; }
        .modal-body { display: flex; flex-direction: column; gap: 10px; }
        .modal-body ul { padding-left: 20px; margin: 0; }
        .modal-body li { margin-bottom: 8px; }

        #importButton { display: none; }
        #exportButton { background-color: var(--success-color); color: white; }
        #importButton-label { background-color: var(--info-color); color: white; }
        #installButton { background-color: #5a31f4; color: white; }
        #clearButton { background-color: var(--danger-color); color: white; }

        .history-log { list-style: none; padding: 0; margin: 0; flex-grow: 1; overflow-y: auto; border-top: 1px solid var(--border-color); min-height: 100px; }
        .history-log li { background: #fff; border: 1px solid #eee; border-radius: 12px; padding: 15px; margin: 10px 0; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); display: flex; flex-direction: column; gap: 8px; transition: box-shadow 0.2s; }
        .history-log li:hover { box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08); }
        .history-item-header { display: flex; justify-content: space-between; align-items: center; }
        .history-item-header .operation { font-weight: 600; font-size: 1.1rem; color: #333; }
        .history-item-actions button { background: none; border: none; cursor: pointer; padding: 4px; color: #aaa; transition: color 0.2s; }
        .history-item-actions button:hover { color: #333; }
        .comment-display { font-style: italic; color: #555; font-size: 0.95rem; white-space: pre-wrap; word-break: break-word; }
        .history-item-footer { text-align: right; font-size: 0.8rem; color: #999; }
        .edit-textarea { width: 100%; font-family: inherit; font-size: 0.95rem; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); resize: none; box-sizing: border-box; }
        .edit-actions { display: flex; gap: 8px; justify-content: flex-end; }
        .edit-actions button { padding: 5px 10px; font-size: 0.85rem; }
    </style>
</head>
<body>
    <div class="calculator">
        <div class="app-header">
            <button id="infoButton" title="–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è">‚ÑπÔ∏è</button>
            <div class="header-actions-right">
                <button id="settingsButton" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</button>
                <button id="closeAppButton" title="–ó–∞–∫—Ä—ã—Ç—å" style="display: none;">‚ùå</button>
            </div>
        </div>
        <div id="total" class="total-display">0</div>
        
        <div class="controls">
            <input type="number" id="numberInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ..." autofocus>
            <textarea id="commentInput" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." rows="1"></textarea>
            <div class="main-actions">
                <button id="addButton">–î–æ–±–∞–≤–∏—Ç—å</button>
                <button id="subtractButton">–û—Ç–Ω—è—Ç—å</button>
            </div>
        </div>
        <ul id="history" class="history-log"></ul>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –¥–∞–Ω–Ω—ã–µ</h2>
                <button class="close-button">&times;</button>
            </div>
            <div class="modal-body">
                <button id="exportButton">–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
                <label for="importButton" id="importButton-label" class="button-label">–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</label>
                <input type="file" id="importButton" accept=".json">
                <button id="installButton" style="display: none;">üì≤ –î–æ–±–∞–≤–∏—Ç—å –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω</button>
                <button id="clearButton">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
            </div>
        </div>
    </div>
    
    <div id="infoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</h2>
                <button class="close-button">&times;</button>
            </div>
            <div class="modal-body">
                <p>–≠—Ç–æ –ø—Ä–æ—Å—Ç–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –≤–µ–¥–µ–Ω–∏—è –ø–æ–¥—Å—á—ë—Ç–æ–≤ —Å –∏—Å—Ç–æ—Ä–∏–µ–π –æ–ø–µ—Ä–∞—Ü–∏–π.</p>
                <ul>
                    <li><b>–î–æ–±–∞–≤–∏—Ç—å/–û—Ç–Ω—è—Ç—å:</b> –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –∏ –Ω–∞–∂–º–∏—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∫–Ω–æ–ø–∫—É.</li>
                    <li><b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</b> –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∫–∞–∂–¥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏.</li>
                    <li><b>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:</b> –ù–∞–∂–º–∏—Ç–µ –∏–∫–æ–Ω–∫—É ‚úèÔ∏è –Ω–∞ –ª—é–±–æ–π –∑–∞–ø–∏—Å–∏, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –µ—ë –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.</li>
                    <li><b>–£–¥–∞–ª–µ–Ω–∏–µ:</b> –ù–∞–∂–º–∏—Ç–µ üóëÔ∏è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏.</li>
                    <li><b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ (‚öôÔ∏è):</b> –ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å, —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.</li>
                    <li><b>–£—Å—Ç–∞–Ω–æ–≤–∫–∞:</b> –í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Ç–∞–∫–∂–µ –µ—Å—Ç—å –∫–Ω–æ–ø–∫–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω –≤–∞—à–µ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.</li>
                </ul>
            </div>
        </div>
    </div>

    <script src="https://jen9-ops.github.io/library/script.js"></script>
    <script>
        // --- –õ–û–ì–ò–ö–ê PWA (–£–°–¢–ê–ù–û–í–ö–ò –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø) ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('Service worker registered.'))
                    .catch(err => console.log('Service worker registration failed: ', err));
            });
        }
        let deferredPrompt;
        const installButton = document.getElementById('installButton');
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installButton.style.display = 'flex';
        });
        installButton.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
                installButton.style.display = 'none';
            }
        });
        window.addEventListener('appinstalled', () => {
          installButton.style.display = 'none';
        });

        // --- –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ---
        document.addEventListener('DOMContentLoaded', () => {
            const numberInput = document.getElementById('numberInput');
            const commentInput = document.getElementById('commentInput');
            const addButton = document.getElementById('addButton');
            const subtractButton = document.getElementById('subtractButton');
            const totalDisplay = document.getElementById('total');
            const historyLog = document.getElementById('history');
            const settingsModal = document.getElementById('settingsModal');
            const settingsButton = document.getElementById('settingsButton');
            const infoModal = document.getElementById('infoModal');
            const infoButton = document.getElementById('infoButton');
            const exportButton = document.getElementById('exportButton');
            const importButton = document.getElementById('importButton');
            const clearButton = document.getElementById('clearButton');
            const closeAppButton = document.getElementById('closeAppButton');
            
            let total = 0;
            let history = [];

            // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥–∞–ª—å–Ω—ã–º–∏ –æ–∫–Ω–∞–º–∏ ---
            const setupModal = (modal, openBtn) => {
                const closeBtn = modal.querySelector('.close-button');
                const open = () => modal.classList.add('active');
                const close = () => modal.classList.remove('active');
                openBtn.addEventListener('click', open);
                closeBtn.addEventListener('click', close);
                modal.addEventListener('click', (e) => { if (e.target === modal) close(); });
            };
            setupModal(settingsModal, settingsButton);
            setupModal(infoModal, infoButton);

            // --- –£—Å–ª–æ–≤–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ "–ó–∞–∫—Ä—ã—Ç—å" ---
            if (window.opener || window.matchMedia('(display-mode: standalone)').matches) {
                closeAppButton.style.display = 'flex';
            }

            // --- –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---
            const autoResizeTextarea = (textarea) => { textarea.style.height = 'auto'; textarea.style.height = textarea.scrollHeight + 'px'; };
            const saveState = () => { try { localStorage.setItem('calculatorState', JSON.stringify({ total, history })); } catch (e) { console.error("Failed to save state:", e); } };
            const loadState = () => { try { const state = JSON.parse(localStorage.getItem('calculatorState')); if (state) { total = state.total; history = state.history || []; } } catch (e) { console.error("Failed to load state:", e); } };
            
            const render = () => {
                totalDisplay.textContent = parseFloat(total.toFixed(4));
                historyLog.innerHTML = '';
                [...history].reverse().forEach((item, index) => {
                    const originalIndex = history.length - 1 - index;
                    const operator = item.type === 'subtract' ? '‚àí' : '+';
                    const li = document.createElement('li');
                    li.innerHTML = `<div class="history-item-header"><span class="operation">${item.previousTotal} ${operator} ${item.value} = ${item.newTotal}</span><div class="history-item-actions"><button class="edit-btn" data-index="${originalIndex}">‚úèÔ∏è</button><button class="delete-btn" data-index="${originalIndex}">üóëÔ∏è</button></div></div><div class="comment-display">${item.comment || ''}</div><div class="history-item-footer">${new Date(item.timestamp).toLocaleString('ru-RU')}</div>`;
                    historyLog.appendChild(li);
                });
            };

            const recalculateTotal = () => {
                let currentTotal = 0;
                history.forEach(item => {
                    item.previousTotal = parseFloat(currentTotal.toFixed(4));
                    if (item.type === 'subtract') { currentTotal -= item.value; } else { currentTotal += item.value; }
                    item.newTotal = parseFloat(currentTotal.toFixed(4));
                });
                total = currentTotal;
            };

            const addOperation = (type) => {
                const value = parseFloat(numberInput.value);
                if (isNaN(value)) return;
                const newTotal = type === 'subtract' ? total - value : total + value;
                history.push({ type: type, value: value, previousTotal: parseFloat(total.toFixed(4)), newTotal: parseFloat(newTotal.toFixed(4)), timestamp: new Date().toISOString(), comment: commentInput.value.trim() });
                total = newTotal;
                numberInput.value = ''; commentInput.value = ''; autoResizeTextarea(commentInput);
                numberInput.focus();
                saveState(); render();
            };

            const clearAll = () => { if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é?')) { total = 0; history = []; saveState(); render(); settingsModal.classList.remove('active'); } };
            const deleteEntry = (index) => { if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?')) { history.splice(index, 1); recalculateTotal(); saveState(); render(); } };
            
            const showEditUI = (index) => {
                const item = history[index];
                const listItem = historyLog.querySelector(`[data-index="${index}"]`).closest('li');
                const commentDisplay = listItem.querySelector('.comment-display');
                const editArea = document.createElement('textarea');
                editArea.className = 'edit-textarea';
                editArea.value = item.comment || '';
                const saveBtn = document.createElement('button');
                saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                saveBtn.style.backgroundColor = 'var(--success-color)';
                saveBtn.style.color = 'white';
                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = '–û—Ç–º–µ–Ω–∞';
                cancelBtn.style.backgroundColor = 'var(--secondary-color)';
                cancelBtn.style.color = 'white';
                const editActions = document.createElement('div');
                editActions.className = 'edit-actions';
                editActions.append(cancelBtn, saveBtn);
                commentDisplay.innerHTML = '';
                commentDisplay.append(editArea, editActions);
                autoResizeTextarea(editArea);
                editArea.addEventListener('input', () => autoResizeTextarea(editArea));
                saveBtn.onclick = () => saveComment(index, editArea.value);
                cancelBtn.onclick = () => render();
            };

            const saveComment = (index, newComment) => { history[index].comment = newComment.trim(); saveState(); render(); };
            
            const exportData = async () => {
                const dataStr = JSON.stringify({ total, history }, null, 2);
                if ('showSaveFilePicker' in window) {
                    try {
                        const handle = await window.showSaveFilePicker({ suggestedName: 'calculator_data.json', types: [{ description: 'JSON Files', accept: { 'application/json': ['.json'] } }] });
                        const writable = await handle.createWritable();
                        await writable.write(dataStr);
                        await writable.close();
                    } catch (err) { console.log('Export cancelled.'); }
                } else {
                    const linkElement = document.createElement('a');
                    linkElement.setAttribute('href', 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr));
                    linkElement.setAttribute('download', 'calculator_data.json');
                    linkElement.click();
                }
            };
            
            const importData = (event) => {
                const fileReader = new FileReader();
                fileReader.onload = (e) => {
                    try {
                        const newState = JSON.parse(e.target.result);
                        if (newState && typeof newState.total === 'number' && Array.isArray(newState.history)) {
                            if (confirm('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ? –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω—ã.')) { total = newState.total; history = newState.history; saveState(); render(); settingsModal.classList.remove('active'); }
                        } else { alert('–û—à–∏–±–∫–∞: –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞.'); }
                    } catch (error) { alert('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞.'); }
                };
                fileReader.readAsText(event.target.files[0]);
                event.target.value = '';
            };

            // --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ---
            addButton.addEventListener('click', () => addOperation('add'));
            subtractButton.addEventListener('click', () => addOperation('subtract'));
            clearButton.addEventListener('click', clearAll);
            exportButton.addEventListener('click', exportData);
            importButton.addEventListener('change', importData);
            closeAppButton.addEventListener('click', () => window.close());
            commentInput.addEventListener('input', () => autoResizeTextarea(commentInput));
            commentInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); document.getElementById('addButton').click(); }});
            historyLog.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const index = parseInt(target.getAttribute('data-index'));
                if (target.classList.contains('delete-btn')) deleteEntry(index);
                if (target.classList.contains('edit-btn')) showEditUI(index);
            });
            
            // --- –ü–ï–†–í–û–ù–ê–ß–ê–õ–¨–ù–´–ô –ó–ê–ü–£–°–ö ---
            loadState();
            render();
        });
    </script>
</body>
</html>
